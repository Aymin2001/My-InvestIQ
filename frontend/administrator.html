<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administrator</title>
    <link rel="stylesheet" href="./css/style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Favicon -->

    <link href="img/favicon.ico" rel="icon" />
    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Jost:wght@500;600;700&family=Open+Sans:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <!-- Link to Font Awesome CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />
    <!-- Icon Font Stylesheet -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <!-- Libraries Stylesheet -->
    <link href="lib/animate/animate.min.css" rel="stylesheet" />
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />

    <!-- Customized Bootstrap Stylesheet -->
    <link href="css/bootstrap.min.css" rel="stylesheet" />
  </head>
  <body>
    <div class="menu-icon" onclick="toggleSidebar()">&#9776;</div>

    <div class="Dashboard-container">
      <div class="sidebar" id="sidebar">
        <span class="close-icon" onclick="toggleSidebar()">&times;</span>
        <h5 class="offcanvas-title" id="offcanvasWithBothOptionsLabel">
          <a
            href="index.html"
            class="navbar-brand ms-4 ms-lg-0 d-flex justify-content-start align-items-end position-relative"
          >
            <img src="./img/logo.png" alt="logo" width="60" height="50" />
            <h1 id="glitterText" class="display-6 m-0 gradient-text">
              Invest<span class="text-purple">I</span
              ><span class="text-cyan">Q</span>
            </h1>
          </a>
        </h5>
        <div class="column">
          <div class="rows mt-5" data-tab="dashboard">
            <i class="fas fa-home"></i>
            <p>Dashboard</p>
          </div>
          <div class="rows" data-tab="feedback">
            <i class="fas fa-comments"></i>
            <p>Feedback</p>
          </div>
          <div class="rows" data-tab="settings">
            <i class="fas fa-cog"></i>
            <p>Settings</p>
          </div>
          <div class="rows" data-tab="profile">
            <i class="fas fa-user"></i>
            <p>Profile</p>
          </div>
          <div class="rows" data-tab="register">
            <i class="fas fa-user"></i>
            <p>Register Admin</p>
          </div>
          <div class="rows" data-tab="logout" id="logoutBtn">
            <i class="fas fa-sign-out-alt"></i>
            <p>Logout</p>
          </div>
        </div>
      </div>

      <div class="content">
        <div class="tab-content active" id="dashboard-content">
          <!-- for service -->
          <div id="alert-container"></div>
          <table id="serviceTable">
            <caption>
              Services Detail
            </caption>
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Email</th>
                <th scope="col">Mobile No</th>
                <th scope="col">Subject</th>
                <th scope="col">Message</th>
                <th scope="col">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tab-content" id="feedback-content">
          <table id="contactTable">
            <caption>
              Contact Us Detail
            </caption>
            <thead>
              <tr>
                <th scope="col">Name</th>
                <th scope="col">Email</th>
                <th scope="col">Subject</th>
                <th scope="col">Message</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="tab-content" id="settings-content">
          <div
            class="modal-content"
            id="modal-content"
            style="width: 100%; max-width: 600px; margin: 5% auto"
          >
            <h3
              id="glitterText"
              class="gradient-text display-5 mb-3 text-center"
            >
              Rese<span class="text-purple">t</span
              ><span class="text-cyan">Password</span>
            </h3>
            <div id="alerts-container"></div>

            <form id="Reset-form">
              <div class="input-group">
                <input
                  type="password"
                  name="currentPassword"
                  placeholder="Current Password"
                  id="current-password"
                  required
                />
              </div>
              <div class="input-group">
                <input
                  type="password"
                  name="newPassword"
                  placeholder="New Password"
                  id="new-password"
                  required
                />
              </div>
              <div class="input-group">
                <input
                  type="password"
                  name="confirmNewPassword"
                  placeholder="Confirm Password"
                  id="confirm-password"
                  required
                />
              </div>
              <div class="input-group">
                <button type="submit" class="submit-button">Submit</button>
              </div>
            </form>
          </div>
        </div>
        <div class="tab-content" id="profile-content">
          <div class="profile-container">
            <div class="profile-content">
              <img src="./img/profileimg.jpg" width="200px" height="200px" />
              <div class="profile-info">
                <span id="admi-name">ADMIN</span>
                <p id="admi-joined-on">Joined on 12 Jan</p>
                <div class="info-icons">
                  <div class="info-item">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="admi-city">City</span>
                  </div>
                  <div class="info-item">
                    <i class="fas fa-phone"></i>
                    <span id="admi-phone">Phone No</span>
                  </div>
                  <div class="info-item">
                    <i class="fas fa-envelope"></i>
                    <span id="admi-email">Email</span>
                  </div>
                  <div class="info-item">
                    <i class="fas fa-calendar-alt"></i>
                    <span id="admi-dob">Date of Birth</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="dropdown" onclick="toggleDropdown()">
              <i class="fas fa-ellipsis-h dot-icon dropdown-dot"></i>
              <div class="dropdown-content" id="dropdownContent">
                <a href="#"><i class="fas fa-cog"></i> Settings</a>
                <a href="#"><i class="fas fa-user-plus"></i> Register</a>
              </div>
            </div>
          </div>
        </div>
        <div class="tab-content" id="register-content">
          <div
            class="modal-content mt-1"
            id="modal-content"
            style="width: 100%; max-width: 650px"
          >
            <h3
              id="glitterText"
              class="gradient-text display-5 mb-3 text-center"
            >
              Regis<span class="text-purple">t</span
              ><span class="text-cyan">er Admin</span>
            </h3>
            <div id="alerts-container"></div>

            <form id="register-form">
              <div class="input-group">
                <input
                  type="email"
                  name="email"
                  placeholder="Email"
                  id="rgstr-email"
                  required
                />
              </div>
              <div class="input-group">
                <input
                  type="password"
                  name="password"
                  placeholder="Password"
                  id="rgstr-pswrd"
                  required
                />
              </div>
              <div class="input-group">
                <input
                  type="text"
                  name="name"
                  placeholder="Name"
                  id="rgstr-name"
                  required
                />
              </div>
              <div class="input-group">
                <input
                  type="date"
                  name="dob"
                  placeholder="Date of Birth"
                  id="rgstr-dob"
                  required
                />
              </div>
              <div class="input-group">
                <input
                  type="text"
                  name="city"
                  placeholder="City"
                  id="rgstr-city"
                  required
                />
              </div>
              <div class="input-group">
                <input
                  type="tel"
                  name="phone"
                  placeholder="Phone Number"
                  id="rgstr-phone"
                  required
                />
              </div>
              <div class="input-group">
                <button type="submit" class="submit-button">Submit</button>
              </div>
            </form>
          </div>
        </div>
        <div class="tab-content" id="logout-content">
          <div id="logout-dialog" class="logout-dialog">
            <div class="logout-dialog-content">
              <span class="close" id="cancelLogout">&times;</span>
              <p>Are you sure you want to logout?</p>
              <button id="confirmLogout">Yes</button>
              <button id="cancelLogoutBtn">No</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- full msg display on modal -->
    <div
      class="modal fade"
      id="messageModal"
      tabindex="-1"
      aria-labelledby="messageModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="messageModalLabel">Full Message</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="fullMessage"></div>
        </div>
      </div>
    </div>

    <!-- toggle sidebar -->
    <script>
      function toggleSidebar() {
        var sidebar = document.getElementById("sidebar");
        sidebar.classList.toggle("show");
      }
    </script>

    <!-- for fetching and deleting service detail -->

    <script>
      fetch("https://my-invest-iq-backend.vercel.app/api/service/getServices")
        .then((response) => response.json())
        .then((data) => {
          const tableBody = document.querySelector("#serviceTable tbody");

          data.forEach((service) => {
            const row = document.createElement("tr");
            const shortMessage = truncateMessage(service.message, 3);
            row.innerHTML = `
        <td scope="row" data-label="Name">${service.name}</td>
        <td scope="row" data-label="Email">${service.email}</td>
        <td scope="row" data-label="Mobile No">${service.mobileNo}</td>
        <td scope="row" data-label="Subject">${service.subject}</td>
        <td scope="row" data-label="Message" title="${service.message}">${shortMessage}</td>
        <td>
          <button class="btn btn-primary btn-view" data-message="${service.message}" data-bs-toggle="modal" data-bs-target="#messageModal">View</button>
          <button class="btn btn-danger btn-delete" data-service-id="${service._id}">Delete</button>
        </td>
      `;
            tableBody.appendChild(row);
          });

          document.querySelectorAll(".btn-view").forEach((button) => {
            button.addEventListener("click", () => {
              const fullMessage = button.getAttribute("data-message");
              document.getElementById("fullMessage").textContent = fullMessage;
            });
          });

          document.querySelectorAll(".btn-delete").forEach((button) => {
            button.addEventListener("click", () => {
              const serviceId = button.getAttribute("data-service-id");
              if (serviceId) {
                deleteService(serviceId);
              } else {
                console.error("Service ID is missing or invalid");
              }
            });
          });
        })
        .catch((error) =>
          console.error("Error fetching service details:", error)
        );

      function deleteService(serviceId) {
        fetch(
          `https://my-invest-iq-backend.vercel.app/api/service/Service/${serviceId}`,
          {
            method: "DELETE",
          }
        )
          .then((response) => {
            if (response.ok) {
              const rowToDelete = document.querySelector(
                `[data-service-id="${serviceId}"]`
              ).parentNode.parentNode;
              rowToDelete.parentNode.removeChild(rowToDelete);
            } else {
              throw new Error("Failed to delete service");
            }
          })
          .catch((error) => console.error("Error deleting service:", error));
      }

      function truncateMessage(message, wordsCount) {
        const words = message.split(" ");
        if (words.length > wordsCount) {
          return words.slice(0, wordsCount).join(" ") + "...";
        }
        return message;
      }
    </script>

    <!-- for fetching and deleting contact detail -->
    <script>
      fetch("https://my-invest-iq-backend.vercel.app/api/contact/getContacts")
        .then((response) => response.json())
        .then((data) => {
          const tableBody = document.querySelector("#contactTable tbody");

          data.forEach((contact) => {
            const row = document.createElement("tr");
            const shortMessage = truncateMessage(contact.message, 3);
            row.innerHTML = `
        <td scope="row" data-label="Name">${contact.name}</td>
        <td scope="row" data-label="Email">${contact.email}</td>
        <td scope="row" data-label="Subject">${contact.subject}</td>
        <td scope="row" data-label="Message" title="${contact.message}">${shortMessage}</td>
        <td>
          <button class="btn btn-primary btn-view" data-message="${contact.message}" data-bs-toggle="modal" data-bs-target="#messageModal">View</button>
          <button class="btn btn-danger btn-delete" data-contact-id="${contact._id}">Delete</button>
        </td>
      `;
            tableBody.appendChild(row);
          });

          document.querySelectorAll(".btn-view").forEach((button) => {
            button.addEventListener("click", () => {
              const fullMessage = button.getAttribute("data-message");
              document.getElementById("fullMessage").textContent = fullMessage;
            });
          });

          document.querySelectorAll(".btn-delete").forEach((button) => {
            button.addEventListener("click", () => {
              const contactId = button.getAttribute("data-contact-id");
              deleteContact(contactId);
            });
          });
        })
        .catch((error) =>
          console.error("Error fetching contact details:", error)
        );

      // Function to delete contact
      function deleteContact(contactId) {
        fetch(
          `https://my-invest-iq-backend.vercel.app/api/contact/Contact/${contactId}`,
          {
            method: "DELETE",
          }
        )
          .then((response) => {
            if (response.ok) {
              const rowToDelete = document.querySelector(
                `[data-contact-id="${contactId}"]`
              ).parentNode.parentNode;
              rowToDelete.parentNode.removeChild(rowToDelete);
            } else {
              throw new Error("Failed to delete contact");
            }
          })
          .catch((error) => console.error("Error deleting contact:", error));
      }

      // Function to truncate message to first three words
      function truncateMessage(message, wordsCount) {
        const words = message.split(" ");
        if (words.length > wordsCount) {
          return words.slice(0, wordsCount).join(" ") + "...";
        }
        return message;
      }
    </script>
    <!-- active tab bar colour -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const tabLinks = document.querySelectorAll(".rows");
        const tabContents = document.querySelectorAll(".tab-content");

        tabLinks.forEach(function (link) {
          link.addEventListener("click", function () {
            const tabId = this.dataset.tab;

            tabContents.forEach(function (content) {
              content.classList.remove("active");
            });

            document.getElementById(tabId).classList.add("active");
          });
        });
      });
    </script>
    <!-- shows content on right side based on selected tab -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const tabs = document.querySelectorAll(".rows");
        const tabContents = document.querySelectorAll(".tab-content");

        tabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const tabData = this.getAttribute("data-tab");
            const content = document.getElementById(`${tabData}-content`);

            tabContents.forEach((item) => {
              item.classList.remove("active");
            });

            content.classList.add("active");
          });
        });
      });
    </script>
    <!-- drop down show -->
    <script>
      function toggleDropdown() {
        var dropdownContent = document.getElementById("dropdownContent");
        dropdownContent.classList.toggle("show-dropdown");
      }
    </script>

    <!-- register new admin -->
    <script>
      document
        .getElementById("register-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const email = document.getElementById("rgstr-email").value;
          const password = document.getElementById("rgstr-pswrd").value;
          const name = document.getElementById("rgstr-name").value;
          const dob = document.getElementById("rgstr-dob").value;
          const city = document.getElementById("rgstr-city").value;
          const phone = document.getElementById("rgstr-phone").value;

          try {
            const formData = {
              email: email,
              password: password,
              name: name,
              dob: dob,
              city: city,
              phoneNo: phone,
            };

            const response = await fetch(
              "https://my-invest-iq-backend.vercel.app/api/auth/register",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify(formData),
              }
            );

            const responseData = await response.json();

            if (!response.ok) {
              throw new Error(
                "Failed to register admin: " + responseData.error
              );
            }

            // Show success message
            const successAlert = document.createElement("div");
            successAlert.classList.add(
              "alert",
              "alert-success",
              "alert-dismissible",
              "fade",
              "show"
            );
            successAlert.setAttribute("role", "alert");
            successAlert.innerHTML = `<strong>Admin</strong> registered successfully
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            document
              .getElementById("alerts-container")
              .appendChild(successAlert);

            // Clear form fields
            document.getElementById("register-form").reset();
          } catch (error) {
            console.error("Error registering admin:", error);

            // Show error message
            const errorAlert = document.createElement("div");
            errorAlert.classList.add(
              "alert",
              "alert-danger",
              "alert-dismissible",
              "fade",
              "show"
            );
            errorAlert.setAttribute("role", "alert");
            errorAlert.innerText = error.message;
            document.getElementById("alerts-container").appendChild(errorAlert);
          }
        });
    </script>

    <!-- get data and show in prifile section of admin -->
    <script>
      window.addEventListener("DOMContentLoaded", async function () {
        const userId = localStorage.getItem("id");

        if (!userId) {
          console.error("User ID not found in local storage");

          return;
        }

        try {
          const response = await fetch(
            `https://my-invest-iq-backend.vercel.app/api/auth/getregisterdetail/${userId}`
          );
          const responseData = await response.json();

          if (!response.ok) {
            throw new Error(
              "Failed to fetch user details: " + responseData.error
            );
          }

          const user = responseData.user;
          const dobDate = user.dob.split("T")[0];

          document.getElementById("admi-name").textContent = user.name;
          document.getElementById(
            "admi-joined-on"
          ).textContent = `Joined on ${user.date}`; // Assuming 'createdAt' field exists
          document.getElementById("admi-city").textContent = user.city;
          document.getElementById("admi-phone").textContent = user.phoneNo;
          document.getElementById("admi-email").textContent = user.email;
          document.getElementById("admi-dob").textContent = dobDate;
        } catch (error) {
          console.error("Error fetching user details:", error);
        }
      });
    </script>

    <!-- logout -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("logoutBtn")
          .addEventListener("click", function () {
            document.getElementById("logout-dialog").style.display = "block";
          });

        document
          .getElementById("cancelLogoutBtn")
          .addEventListener("click", function () {
            document.getElementById("logout-dialog").style.display = "none";
          });

        document
          .getElementById("confirmLogout")
          .addEventListener("click", function () {
            localStorage.removeItem("authToken");

            window.location.href = "adminLogin.html";
          });

        // Hide logout dialog when close button is clicked
        document
          .getElementById("cancelLogout")
          .addEventListener("click", function () {
            document.getElementById("logout-dialog").style.display = "none";
          });
      });
    </script>

    <!-- reset passwword -->
    <script>
      document
        .getElementById("Reset-form")
        .addEventListener("submit", async function (event) {
          event.preventDefault();

          const alertContainer = document.getElementById("alert-container");
          alertContainer.innerHTML = "";

          const currentPassword =
            document.getElementById("current-password").value;
          const newPassword = document.getElementById("new-password").value;
          const confirmPassword =
            document.getElementById("confirm-password").value;

          const userId = localStorage.getItem("id");

          if (!userId) {
            console.error("User ID not found in local storage");
            return;
          }

          try {
            const response = await fetch(
              `https://my-invest-iq-backend.vercel.app/api/auth/reset-password/${userId}`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  currentPassword: currentPassword,
                  newPassword: newPassword,
                  confirmNewPassword: confirmPassword,
                }),
              }
            );

            const responseData = await response.json();

            if (!response.ok) {
              throw new Error(responseData.error || "Failed to reset password");
            }

            // Show success message
            const successAlert = document.createElement("div");
            successAlert.classList.add(
              "alert",
              "alert-success",
              "alert-dismissible",
              "fade",
              "show"
            );
            successAlert.setAttribute("role", "alert");
            successAlert.innerHTML = `<strong>Password</strong> reset successfully
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>`;
            document
              .getElementById("alerts-container")
              .appendChild(successAlert);

            // Clear form fields
            document.getElementById("Reset-form").reset();
          } catch (error) {
            console.error("Error resetting password:", error);
            // Show error message
            const errorAlert = document.createElement("div");
            errorAlert.classList.add(
              "alert",
              "alert-danger",
              "alert-dismissible",
              "fade",
              "show"
            );
            errorAlert.setAttribute("role", "alert");
            errorAlert.innerText = error.message;
            document.getElementById("alerts-container").appendChild(errorAlert);
          }
        });

      function createAlert(type, message) {
        const alertDiv = document.createElement("div");
        alertDiv.classList.add("alert", type, "mt-3");

        const closeButton = document.createElement("button");
        closeButton.setAttribute("type", "button");
        closeButton.classList.add("btn-close");
        closeButton.setAttribute("data-bs-dismiss", "alert");
        closeButton.setAttribute("aria-label", "Close");
        alertDiv.appendChild(closeButton);

        const messageText = document.createTextNode(message);
        alertDiv.appendChild(messageText);

        return alertDiv;
      }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Include jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  </body>
</html>
